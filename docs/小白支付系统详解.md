# ğŸ“ å°ç™½æ”¯ä»˜ç³»ç»Ÿè¯¦è§£ - ä»é›¶å¼€å§‹ç†è§£åŒæ”¯ä»˜

## ğŸ“š ä½ çš„ç–‘é—®æˆ‘æ¥ä¸€ä¸€è§£ç­”

### â“ **ç–‘é—®1: ä¸¤ä¸ªæ¨¡æ¿çš„æ”¯ä»˜é€»è¾‘æ˜¯ä¸æ˜¯ä¸€æ¨¡ä¸€æ ·ï¼Ÿ**

**ç­”æ¡ˆï¼šä¸æ˜¯ï¼å·®å¼‚å¾ˆå¤§ï¼**

#### ğŸŸ¢ **V1æ¨¡æ¿ (Creem) - ç®€å•ç‰ˆ**
```typescript
// åªæœ‰ä¸€ä¸ªå‡½æ•°ï¼Œè¶…çº§ç®€å•
export async function createCheckoutSession(
  productId: string,
  email: string,
  userId: string,
  productType: "subscription" | "credits"
) {
  // ç›´æ¥è°ƒç”¨Creem APIï¼Œæ²¡æœ‰å¤æ‚éªŒè¯
  const response = await fetch(process.env.CREEM_API_URL + "/checkouts", {
    method: "POST",
    headers: { "x-api-key": process.env.CREEM_API_KEY! },
    body: JSON.stringify({
      product_id: productId,
      customer: { email },
      metadata: { user_id: userId, product_type: productType }
    })
  })
  
  return data.checkout_url  // ç›´æ¥è¿”å›æ”¯ä»˜é“¾æ¥
}
```

#### ğŸ”µ **Shipanyæ¨¡æ¿ (Stripe) - ä¼ä¸šçº§**
```typescript
// å¤æ‚çš„APIè·¯ç”±ï¼Œæœ‰ä¸¥æ ¼éªŒè¯
export async function POST(req: Request) {
  // 1. ä¸¥æ ¼çš„å‚æ•°éªŒè¯
  if (!amount || !interval || !currency || !product_id) {
    return respErr("invalid params")
  }

  // 2. ğŸ”¥ ä»å®šä»·è¡¨éªŒè¯å‚æ•°ï¼ˆé˜²æ­¢ç¯¡æ”¹ï¼‰
  const page = await getPricingPage("en")
  const item = page.pricing.items.find(item => item.product_id === product_id)
  if (item.amount !== amount) {
    return respErr("invalid checkout params")  // ä»·æ ¼ä¸åŒ¹é…ï¼Œæ‹’ç»ï¼
  }

  // 3. è®¡ç®—è¿‡æœŸæ—¶é—´
  const timePeriod = new Date(currentDate)
  timePeriod.setMonth(currentDate.getMonth() + valid_months)
  if (is_subscription) {
    delayTimeMillis = 24 * 60 * 60 * 1000 // è®¢é˜…å»¶è¿Ÿ24å°æ—¶
  }

  // 4. å…ˆä¿å­˜è®¢å•åˆ°æ•°æ®åº“
  await insertOrder(order)

  // 5. åˆ›å»ºStripeä¼šè¯
  const session = await stripe.checkout.sessions.create(options)
  
  // 6. æ›´æ–°è®¢å•çš„Stripeä¼šè¯ID
  await updateOrderSession(order_no, session.id, order_detail)
}
```

### ğŸ“Š **å…³é”®å·®å¼‚å¯¹æ¯”**

| ç‰¹æ€§ | V1æ¨¡æ¿ (Creem) | Shipanyæ¨¡æ¿ (Stripe) | å½“å‰é¡¹ç›® |
|------|---------------|---------------------|----------|
| **å¤æ‚åº¦** | â­ è¶…ç®€å• | â­â­â­â­â­ ä¼ä¸šçº§ | â­â­â­â­ èåˆç‰ˆ |
| **ä»·æ ¼éªŒè¯** | âŒ æ— éªŒè¯ | âœ… ä¸¥æ ¼éªŒè¯ | âœ… æœ‰éªŒè¯ |
| **è®¢å•ç®¡ç†** | âŒ æ— è®¢å•è¡¨ | âœ… å®Œæ•´è®¢å•ç³»ç»Ÿ | âœ… ç»Ÿä¸€è®¢å•è¡¨ |
| **è¿‡æœŸæ—¶é—´** | âŒ æ— è®¡ç®— | âœ… ç²¾ç¡®è®¡ç®— | âœ… æŒ‰æ¨¡æ¿æ ‡å‡† |
| **é”™è¯¯å¤„ç†** | âŒ åŸºç¡€å¤„ç† | âœ… æ ‡å‡†åŒ–å“åº” | âœ… å®Œæ•´é”™è¯¯å¤„ç† |

---

## â“ **ç–‘é—®2: ç»Ÿä¸€æ•°æ®åº“è®¾è®¡åˆ°åº•æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿ**

### ğŸ¯ **ç”¨æœ€ç®€å•çš„ä¾‹å­è¯´æ˜**

æƒ³è±¡ä½ æœ‰ä¸€ä¸ª**è®¢å•è®°å½•æœ¬**ï¼š

#### ğŸ“ **ä¼ ç»Ÿåšæ³•ï¼ˆåˆ†å¼€çš„æ•°æ®åº“ï¼‰**
```
Stripeè®¢å•æœ¬:
è®¢å•1: ç”¨æˆ·A, $10, stripe_session_123
è®¢å•2: ç”¨æˆ·B, $20, stripe_session_456

Creemè®¢å•æœ¬:
è®¢å•1: ç”¨æˆ·C, Â¥50, creem_checkout_789
è®¢å•2: ç”¨æˆ·A, Â¥30, creem_checkout_101
```
**é—®é¢˜**: ç”¨æˆ·Açš„è®¢å•åˆ†æ•£åœ¨ä¸¤ä¸ªæœ¬å­é‡Œï¼ŒæŸ¥è¯¢éº»çƒ¦ï¼

#### âœ… **ç»Ÿä¸€åšæ³•ï¼ˆæˆ‘ä»¬çš„è®¾è®¡ï¼‰**
```
ç»Ÿä¸€è®¢å•æœ¬:
è®¢å•1: ç”¨æˆ·A, $10, æ”¯ä»˜æ–¹å¼=stripe, stripe_session_123, creemå­—æ®µ=ç©º
è®¢å•2: ç”¨æˆ·B, $20, æ”¯ä»˜æ–¹å¼=stripe, stripe_session_456, creemå­—æ®µ=ç©º  
è®¢å•3: ç”¨æˆ·C, Â¥50, æ”¯ä»˜æ–¹å¼=creem, stripeå­—æ®µ=ç©º, creem_checkout_789
è®¢å•4: ç”¨æˆ·A, Â¥30, æ”¯ä»˜æ–¹å¼=creem, stripeå­—æ®µ=ç©º, creem_checkout_101
```

### ğŸ’¾ **æ•°æ®åº“è¡¨å®é™…ç»“æ„**
```sql
PaymentOrder è¡¨:
id | userId | paymentProvider | stripeSessionId | creemCheckoutId | amount | status
1  | A      | stripe         | sess_123        | NULL           | 1000   | completed
2  | B      | stripe         | sess_456        | NULL           | 2000   | completed  
3  | C      | creem          | NULL            | checkout_789   | 5000   | completed
4  | A      | creem          | NULL            | checkout_101   | 3000   | completed
```

### ğŸ” **æŸ¥è¯¢ç”¨æˆ·Açš„æ‰€æœ‰è®¢å•**
```sql
-- ä¸€æ¡SQLå°±èƒ½æŸ¥åˆ°ç”¨æˆ·Açš„æ‰€æœ‰è®¢å•ï¼ˆä¸ç®¡ç”¨å“ªä¸ªæ”¯ä»˜ç³»ç»Ÿï¼‰
SELECT * FROM PaymentOrder WHERE userId = 'A'

ç»“æœ:
è®¢å•1: $10, stripeæ”¯ä»˜
è®¢å•4: Â¥30, creemæ”¯ä»˜
```

---

## â“ **ç–‘é—®3: ç”¨æˆ·ç”¨Stripeæ”¯ä»˜äº†ï¼ŒCreemè¿˜éœ€è¦éªŒè¯å—ï¼Ÿ**

**ç­”æ¡ˆï¼šä¸éœ€è¦ï¼æ¯ä¸ªæ”¯ä»˜ç³»ç»Ÿç‹¬ç«‹éªŒè¯**

### ğŸ”„ **æ”¯ä»˜æµç¨‹è¯¦è§£**

#### 1ï¸âƒ£ **ç”¨æˆ·é€‰æ‹©Stripeæ”¯ä»˜**
```typescript
// ç³»ç»Ÿå†³å®šä½¿ç”¨Stripe
const provider = "stripe"

// åªè°ƒç”¨Stripe API
const session = await stripe.checkout.sessions.create({...})

// åªä¿å­˜Stripeç›¸å…³ä¿¡æ¯åˆ°æ•°æ®åº“
await prisma.paymentOrder.create({
  paymentProvider: "stripe",
  stripeSessionId: session.id,  // âœ… å¡«å†™
  creemCheckoutId: null,        // âŒ ç©ºç™½
  amount: 1000,
  status: "pending"
})
```

#### 2ï¸âƒ£ **Stripeæ”¯ä»˜æˆåŠŸå**
```typescript
// åªæœ‰Stripeçš„Webhookä¼šè¢«è°ƒç”¨
// /api/webhooks/stripe
export async function POST(req: Request) {
  const event = stripe.webhooks.constructEvent(body, signature, secret)
  
  if (event.type === 'checkout.session.completed') {
    // åªæ›´æ–°Stripeè®¢å•
    await prisma.paymentOrder.update({
      where: { stripeSessionId: session.id },  // é€šè¿‡Stripe IDæŸ¥æ‰¾
      data: { status: "completed" }
    })
  }
}

// Creemçš„Webhookä¸ä¼šè¢«è°ƒç”¨ï¼Œå› ä¸ºæ²¡æœ‰Creemæ”¯ä»˜
```

#### 3ï¸âƒ£ **å¦‚æœç”¨æˆ·é€‰æ‹©Creemæ”¯ä»˜**
```typescript
// ç³»ç»Ÿå†³å®šä½¿ç”¨Creem
const provider = "creem"

// åªè°ƒç”¨Creem API
const response = await fetch(CREEM_API_URL + "/checkouts", {...})

// åªä¿å­˜Creemç›¸å…³ä¿¡æ¯åˆ°æ•°æ®åº“
await prisma.paymentOrder.create({
  paymentProvider: "creem",
  stripeSessionId: null,        // âŒ ç©ºç™½
  creemCheckoutId: response.id, // âœ… å¡«å†™
  amount: 1000,
  status: "pending"
})
```

### ğŸ›¡ï¸ **å®‰å…¨æœºåˆ¶ï¼šåŒé‡éªŒè¯**

#### âœ… **StripeéªŒè¯æœºåˆ¶**
```typescript
// Stripe WebhookéªŒè¯ç­¾å
const signature = req.headers.get("stripe-signature")
const event = stripe.webhooks.constructEvent(body, signature, STRIPE_SECRET)
// åªæœ‰çœŸæ­£çš„Stripeé€šçŸ¥æ‰èƒ½é€šè¿‡éªŒè¯
```

#### âœ… **CreeméªŒè¯æœºåˆ¶**
```typescript
// Creem WebhookéªŒè¯ç­¾å
const signature = req.headers.get("creem-signature")
const isValid = verifyCreemWebhookSignature(body, signature, CREEM_SECRET)
// åªæœ‰çœŸæ­£çš„Creemé€šçŸ¥æ‰èƒ½é€šè¿‡éªŒè¯
```

---

## â“ **ç–‘é—®4: å¦‚ä½•é˜²æ­¢ç”¨æˆ·ä¸æ”¯ä»˜å°±èƒ½ä½¿ç”¨ï¼Ÿ**

### ğŸ”’ **å¤šé‡å®‰å…¨æœºåˆ¶**

#### 1ï¸âƒ£ **è®¢å•çŠ¶æ€æ£€æŸ¥**
```typescript
// ç”¨æˆ·æƒ³è¦ç”Ÿæˆè§†é¢‘æ—¶
export async function generateVideo(userId: string, prompt: string) {
  // 1. æ£€æŸ¥ç”¨æˆ·ç§¯åˆ†
  const user = await prisma.user.findUnique({ where: { id: userId } })
  if (user.credits < 10) {
    throw new Error("ç§¯åˆ†ä¸è¶³ï¼Œè¯·å…ˆè´­ä¹°ç§¯åˆ†")
  }
  
  // 2. æ‰£é™¤ç§¯åˆ†
  await prisma.user.update({
    where: { id: userId },
    data: { credits: user.credits - 10 }
  })
  
  // 3. è®°å½•ç§¯åˆ†ä½¿ç”¨
  await prisma.creditTransaction.create({
    data: {
      userId,
      amount: -10,
      type: "usage",
      description: "ç”Ÿæˆè§†é¢‘æ¶ˆè€—ç§¯åˆ†"
    }
  })
  
  // 4. ç”Ÿæˆè§†é¢‘
  const video = await generateAIVideo(prompt)
  return video
}
```

#### 2ï¸âƒ£ **æ”¯ä»˜å®Œæˆæ‰åŠ ç§¯åˆ†**
```typescript
// Stripeæ”¯ä»˜æˆåŠŸWebhook
if (event.type === 'checkout.session.completed') {
  const session = event.data.object
  
  // 1. éªŒè¯è®¢å•å­˜åœ¨ä¸”æœªå¤„ç†
  const order = await prisma.paymentOrder.findUnique({
    where: { stripeSessionId: session.id }
  })
  
  if (!order || order.status !== "pending") {
    throw new Error("è®¢å•ä¸å­˜åœ¨æˆ–å·²å¤„ç†")
  }
  
  // 2. æ›´æ–°è®¢å•çŠ¶æ€
  await prisma.paymentOrder.update({
    where: { id: order.id },
    data: { 
      status: "completed",
      paidAt: new Date()
    }
  })
  
  // 3. æ·»åŠ ç§¯åˆ†ï¼ˆåªæœ‰è¿™æ—¶å€™æ‰åŠ ï¼ï¼‰
  await prisma.user.update({
    where: { id: order.userId },
    data: { 
      credits: { increment: session.metadata.credits }
    }
  })
  
  // 4. è®°å½•ç§¯åˆ†äº¤æ˜“
  await prisma.creditTransaction.create({
    data: {
      userId: order.userId,
      amount: session.metadata.credits,
      type: "purchase",
      description: "è´­ä¹°ç§¯åˆ†",
      paymentOrderId: order.id
    }
  })
}
```

#### 3ï¸âƒ£ **é˜²æ­¢é‡å¤å¤„ç†**
```typescript
// æ£€æŸ¥è®¢å•æ˜¯å¦å·²ç»å¤„ç†è¿‡
const existingOrder = await prisma.paymentOrder.findUnique({
  where: { stripeSessionId: session.id }
})

if (existingOrder.status === "completed") {
  console.log("è®¢å•å·²å¤„ç†ï¼Œè·³è¿‡")
  return  // é˜²æ­¢é‡å¤åŠ ç§¯åˆ†
}
```

---

## â“ **ç–‘é—®5: payment.tsæ–‡ä»¶å¦‚ä½•å¿«é€ŸåŒºåˆ†ï¼Ÿ**

### ğŸ“ **é¡¹ç›®ä¸­æ‰€æœ‰paymentç›¸å…³æ–‡ä»¶**

```
é¡¹ç›®ç»“æ„:
src/
â”œâ”€â”€ lib/
â”‚   â”œâ”€â”€ config/
â”‚   â”‚   â””â”€â”€ payment.ts          â† ğŸ¯ è¿™æ˜¯é…ç½®æ–‡ä»¶ï¼ˆä½ è¦ç¼–è¾‘çš„ï¼‰
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â””â”€â”€ payment-database.ts â† æ•°æ®åº“æ“ä½œ
â”‚   â””â”€â”€ payment.ts              â† ä¸»è¦æ”¯ä»˜é€»è¾‘
â”œâ”€â”€ app/api/
â”‚   â””â”€â”€ payment/
â”‚       â””â”€â”€ create-session/
â”‚           â””â”€â”€ route.ts        â† APIæ¥å£
```

### ğŸ¯ **å¦‚ä½•å¿«é€ŸåŒºåˆ†ï¼Ÿ**

#### 1ï¸âƒ£ **é…ç½®æ–‡ä»¶ (ä½ è¦ç¼–è¾‘çš„)**
```typescript
// ğŸ“ ä½ç½®: src/lib/config/payment.ts
// ğŸ¯ ä½œç”¨: æ‰‹åŠ¨æ§åˆ¶æ”¯ä»˜ç³»ç»Ÿå¼€å…³

export const PAYMENT_CONFIG = {
  STRIPE_ENABLED: true,     // â† ä½ è¦ä¿®æ”¹è¿™äº›
  CREEM_ENABLED: true,      // â† ä½ è¦ä¿®æ”¹è¿™äº›
  DEFAULT_PROVIDER: "creem", // â† ä½ è¦ä¿®æ”¹è¿™äº›
  MAINTENANCE_MODE: false,   // â† ä½ è¦ä¿®æ”¹è¿™äº›
  
  // å¿…å¡«è¯´æ˜
  LAST_UPDATED: "2025-01-20",
  UPDATED_BY: "ä½ çš„åå­—",     // â† ä½ è¦ä¿®æ”¹è¿™ä¸ª
  NOTES: "ä¿®æ”¹åŸå› "          // â† ä½ è¦ä¿®æ”¹è¿™ä¸ª
}
```

#### 2ï¸âƒ£ **ä¸»è¦æ”¯ä»˜é€»è¾‘ (ä¸è¦åŠ¨)**
```typescript
// ğŸ“ ä½ç½®: src/lib/payment.ts
// ğŸ¯ ä½œç”¨: æ ¸å¿ƒæ”¯ä»˜ä¸šåŠ¡é€»è¾‘

export async function createPaymentSession(params) {
  // å¤æ‚çš„æ”¯ä»˜é€»è¾‘ï¼Œä¸è¦ä¿®æ”¹
}
```

#### 3ï¸âƒ£ **APIæ¥å£ (ä¸è¦åŠ¨)**
```typescript
// ğŸ“ ä½ç½®: src/app/api/payment/create-session/route.ts
// ğŸ¯ ä½œç”¨: å¤„ç†å‰ç«¯æ”¯ä»˜è¯·æ±‚

export async function POST(req: Request) {
  // APIå¤„ç†é€»è¾‘ï¼Œä¸è¦ä¿®æ”¹
}
```

### ğŸ” **å¿«é€Ÿè¯†åˆ«æ–¹æ³•**

#### âœ… **æ­£ç¡®çš„é…ç½®æ–‡ä»¶ç‰¹å¾**
```typescript
// 1. æ–‡ä»¶è·¯å¾„åŒ…å« config
src/lib/config/payment.ts

// 2. æ–‡ä»¶å¼€å¤´æœ‰æ³¨é‡Š
// ğŸ”§ æ”¯ä»˜ç³»ç»Ÿæ‰‹åŠ¨é…ç½®æ–‡ä»¶
// ç®¡ç†å‘˜å¯ä»¥ç›´æ¥ä¿®æ”¹è¿™ä¸ªæ–‡ä»¶æ¥æ§åˆ¶åŒæ”¯ä»˜ç³»ç»Ÿ

// 3. æœ‰ PAYMENT_CONFIG å¯¹è±¡
export const PAYMENT_CONFIG = {

// 4. æœ‰ç®€å•çš„å¸ƒå°”å€¼é…ç½®
STRIPE_ENABLED: true,
CREEM_ENABLED: true,
```

#### âŒ **å…¶ä»–æ–‡ä»¶ç‰¹å¾ï¼ˆä¸è¦åŠ¨ï¼‰**
```typescript
// 1. æœ‰å¤æ‚çš„å‡½æ•°
export async function createPaymentSession(...)

// 2. æœ‰APIè·¯ç”±å¤„ç†
export async function POST(req: Request)

// 3. æœ‰æ•°æ®åº“æ“ä½œ
await prisma.paymentOrder.create(...)
```

---

## ğŸ”§ **å®é™…æ“ä½œï¼šå¦‚ä½•ä¿®æ”¹é…ç½®**

### ğŸ“ **æ­¥éª¤1: æ‰¾åˆ°æ­£ç¡®çš„æ–‡ä»¶**
```bash
# åœ¨VS Codeä¸­æŒ‰ Ctrl+Pï¼Œç„¶åè¾“å…¥:
config/payment.ts

# æˆ–è€…ç›´æ¥å¯¼èˆªåˆ°:
src/lib/config/payment.ts
```

### ğŸ“ **æ­¥éª¤2: ä¿®æ”¹é…ç½®**
```typescript
// ğŸ”§ æ”¯ä»˜ç³»ç»Ÿæ‰‹åŠ¨é…ç½®æ–‡ä»¶
export const PAYMENT_CONFIG = {
  // === ğŸ¯ ä¸»è¦æ§åˆ¶å¼€å…³ ===
  STRIPE_ENABLED: true,        // æ”¹æˆ false å…³é—­Stripe
  CREEM_ENABLED: false,        // æ”¹æˆ true å¼€å¯Creem
  DEFAULT_PROVIDER: "stripe",  // æ”¹æˆ "creem" æˆ– "stripe"
  MAINTENANCE_MODE: false,     // æ”¹æˆ true æš‚åœæ‰€æœ‰æ”¯ä»˜
  
  // === ğŸ“Š é«˜çº§é…ç½® ===
  FORCE_PROVIDER: "stripe",    // å¼ºåˆ¶æ‰€æœ‰ç”¨æˆ·ç”¨Stripe
  
  // === ğŸ“ é…ç½®è¯´æ˜ï¼ˆå¿…å¡«ï¼‰===
  LAST_UPDATED: "2025-01-20",
  UPDATED_BY: "ä½ çš„åå­—",       // æ”¹æˆä½ çš„åå­—
  NOTES: "åªå¯ç”¨Stripeæµ‹è¯•"     // å†™æ˜ä¿®æ”¹åŸå› 
}
```

### ğŸ“ **æ­¥éª¤3: æ£€æŸ¥é…ç½®**
```bash
# è¿è¡Œæ£€æŸ¥è„šæœ¬
node scripts/check-payment-config.js
```

### ğŸ“ **æ­¥éª¤4: é‡å¯æœåŠ¡å™¨**
```bash
# æŒ‰ Ctrl+C åœæ­¢æœåŠ¡å™¨
# ç„¶åé‡æ–°å¯åŠ¨
npm run dev
```

---

## ğŸ”’ **å®‰å…¨æ¼æ´æ£€æŸ¥æ¸…å•**

### âœ… **å¿…é¡»æ£€æŸ¥çš„5ä¸ªå…³é”®ç‚¹**

#### 1ï¸âƒ£ **ä»·æ ¼éªŒè¯**
```typescript
// âœ… æ£€æŸ¥: src/app/api/payment/create-session/route.ts
// ç¡®ä¿æœ‰è¿™æ®µä»£ç :
const item = page.pricing.items.find(item => item.product_id === product_id)
if (item.amount !== amount) {
  throw new ValidationError("ä»·æ ¼ä¸åŒ¹é…")  // å¿…é¡»æœ‰è¿™ä¸ªæ£€æŸ¥ï¼
}
```

#### 2ï¸âƒ£ **Webhookç­¾åéªŒè¯**
```typescript
// âœ… æ£€æŸ¥: src/app/api/webhooks/stripe/route.ts
const signature = req.headers.get("stripe-signature")
const event = stripe.webhooks.constructEvent(body, signature, secret)
// å¿…é¡»éªŒè¯ç­¾åï¼

// âœ… æ£€æŸ¥: src/app/api/webhooks/creem/route.ts
const isValid = verifyCreemWebhookSignature(body, signature, secret)
if (!isValid) return new Response("Invalid signature", { status: 401 })
// å¿…é¡»éªŒè¯ç­¾åï¼
```

#### 3ï¸âƒ£ **ç”¨æˆ·æƒé™æ£€æŸ¥**
```typescript
// âœ… æ£€æŸ¥æ‰€æœ‰APIæ–‡ä»¶ï¼Œç¡®ä¿æœ‰:
const session = await getServerSession(authOptions)
if (!session?.user?.id) {
  return Response.json({ error: "æœªç™»å½•" }, { status: 401 })
}
// å¿…é¡»éªŒè¯ç”¨æˆ·ç™»å½•ï¼
```

#### 4ï¸âƒ£ **ç¯å¢ƒå˜é‡å®‰å…¨**
```bash
# âœ… æ£€æŸ¥ .env.local æ–‡ä»¶
# ç¡®ä¿æ²¡æœ‰åœ¨ä»£ç ä¸­ç¡¬ç¼–ç å¯†é’¥
grep -r "sk_test_" src/  # ä¸åº”è¯¥æœ‰ç»“æœ
grep -r "pk_test_" src/  # ä¸åº”è¯¥æœ‰ç»“æœ
```

#### 5ï¸âƒ£ **è®¢å•é‡å¤å¤„ç†é˜²æŠ¤**
```typescript
// âœ… æ£€æŸ¥Webhookå¤„ç†ï¼Œç¡®ä¿æœ‰:
if (existingOrder.status === "completed") {
  console.log("è®¢å•å·²å¤„ç†ï¼Œè·³è¿‡")
  return  // é˜²æ­¢é‡å¤å¤„ç†
}
```

---

## ğŸ¯ **æ€»ç»“ï¼šä½ ç°åœ¨åº”è¯¥æ˜ç™½çš„**

### ğŸ“š **æ ¸å¿ƒæ¦‚å¿µ**
1. **ä¸¤ä¸ªæ¨¡æ¿å·®å¼‚å¾ˆå¤§**: V1ç®€å•ï¼ŒShipanyå¤æ‚ï¼Œæˆ‘ä»¬èåˆäº†ä¸¤è€…ä¼˜ç‚¹
2. **ç»Ÿä¸€æ•°æ®åº“**: ä¸€ä¸ªè¡¨å­˜å‚¨æ‰€æœ‰è®¢å•ï¼Œç”¨å­—æ®µåŒºåˆ†æ”¯ä»˜ç³»ç»Ÿ
3. **ç‹¬ç«‹éªŒè¯**: Stripeå’ŒCreemå„è‡ªéªŒè¯ï¼Œä¸ä¼šäº’ç›¸å¹²æ‰°
4. **å¤šé‡å®‰å…¨**: ä»·æ ¼éªŒè¯ã€ç­¾åéªŒè¯ã€æƒé™æ£€æŸ¥ã€é‡å¤å¤„ç†é˜²æŠ¤
5. **é…ç½®æ–‡ä»¶**: åªæœ‰ä¸€ä¸ª `src/lib/config/payment.ts` éœ€è¦ä½ ä¿®æ”¹

### ğŸ”§ **å®é™…æ“ä½œ**
1. **ä¿®æ”¹é…ç½®**: ç¼–è¾‘ `src/lib/config/payment.ts`
2. **æ£€æŸ¥çŠ¶æ€**: è¿è¡Œ `node scripts/check-payment-config.js`
3. **é‡å¯æœåŠ¡**: `npm run dev`
4. **æäº¤å¤‡ä»½**: `git commit -m "ä¿®æ”¹æ”¯ä»˜é…ç½®"`

### ğŸ”’ **å®‰å…¨æ£€æŸ¥**
1. **ä»·æ ¼éªŒè¯**: ç¡®ä¿ä»æœåŠ¡ç«¯éªŒè¯ä»·æ ¼
2. **ç­¾åéªŒè¯**: ç¡®ä¿Webhookæœ‰ç­¾åéªŒè¯
3. **æƒé™æ£€æŸ¥**: ç¡®ä¿APIæœ‰ç”¨æˆ·éªŒè¯
4. **ç¯å¢ƒå˜é‡**: ç¡®ä¿å¯†é’¥ä¸åœ¨ä»£ç ä¸­
5. **é‡å¤é˜²æŠ¤**: ç¡®ä¿è®¢å•ä¸ä¼šé‡å¤å¤„ç†

ç°åœ¨ä½ åº”è¯¥å®Œå…¨ç†è§£äº†ï¼æœ‰ä»»ä½•å…·ä½“é—®é¢˜éƒ½å¯ä»¥ç»§ç»­é—®æˆ‘ã€‚ 